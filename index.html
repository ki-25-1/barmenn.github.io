<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Manager - –§–æ–Ω—Ç–∞–Ω</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .btn-xl { padding: 15px 20px; font-size: 1.2rem; width: 100%; margin-bottom: 10px; }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –∑–≤—ñ—Ç—É (—è–∫ –Ω–∞ —Ñ–æ—Ç–æ) */
        #reportTable { width: 100%; border-collapse: collapse; background: white; font-family: 'Courier New', Courier, monospace; font-size: 14px; }
        #reportTable th, #reportTable td { border: 2px solid #000; padding: 4px 8px; }
        #reportTable th { text-align: left; background-color: #eee; }
        .print-header { display: none; margin-bottom: 10px; font-weight: bold; }

        @media print {
            body * { visibility: hidden; }
            #reportSection, #reportSection * { visibility: visible; }
            #reportSection { position: absolute; left: 0; top: 0; width: 100%; }
            .print-header { display: block; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="text-center mb-4">üç∫ Bar Manager System</h2>

    <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
        <li class="nav-item"><button class="nav-link active" id="pills-sale-tab" data-bs-toggle="pill" data-bs-target="#pills-sale" type="button">üí∞ –ü—Ä–æ–¥–∞–∂</button></li>
        <li class="nav-item"><button class="nav-link" id="pills-supply-tab" data-bs-toggle="pill" data-bs-target="#pills-supply" type="button">üöö –ü–æ—Å—Ç–∞–≤–∫–∞</button></li>
        <li class="nav-item"><button class="nav-link" id="pills-report-tab" data-bs-toggle="pill" data-bs-target="#pills-report" type="button">üìÑ –ó–≤—ñ—Ç (–Ø–∫ –Ω–∞ —Ñ–æ—Ç–æ)</button></li>
        <li class="nav-item"><button class="nav-link" id="pills-add-tab" data-bs-toggle="pill" data-bs-target="#pills-add" type="button">‚ûï –ù–æ–≤–∏–π —Ç–æ–≤–∞—Ä</button></li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        
        <div class="tab-pane fade show active" id="pills-sale">
            <div class="card p-4">
                <h4>–ü—Ä–æ–≤–µ—Å—Ç–∏ –ø—Ä–æ–¥–∞–∂</h4>
                <div class="mb-3">
                    <label>–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä:</label>
                    <select id="saleProduct" class="form-select" onchange="updateUnitLabel('sale')"></select>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å / –û–±'—î–º:</label>
                        <div class="input-group">
                            <input type="number" step="0.001" id="saleAmount" class="form-control" placeholder="0.5">
                            <span class="input-group-text" id="saleUnitLabel">—à—Ç</span>
                        </div>
                        <small class="text-muted">–î–ª—è –ø–∏–≤–∞ –≤–∫–∞–∂—ñ—Ç—å –æ–±'—î–º –∫–µ–ª–∏—Ö–∞ (–Ω–∞–ø—Ä. 0.5 –∞–±–æ 0.33)</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>–ê–∫—Ü–∏–∑–Ω–∞ –º–∞—Ä–∫–∞ (–¥–ª—è –∞–ª–∫–æ–≥–æ–ª—é):</label>
                        <input type="text" id="exciseCode" class="form-control" placeholder="–°–∫–∞–Ω—É–≤–∞—Ç–∏ —Å—é–¥–∏...">
                    </div>
                </div>

                <button onclick="handleTransaction('sale')" class="btn btn-danger btn-xl">–ü—Ä–æ–¥–∞—Ç–∏</button>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-supply">
            <div class="card p-4">
                <h4>–ü—Ä–∏–π–Ω—è—Ç–∏ —Ç–æ–≤–∞—Ä</h4>
                <div class="mb-3">
                    <label>–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä:</label>
                    <select id="supplyProduct" class="form-select" onchange="updateUnitLabel('supply')"></select>
                </div>
                <div class="mb-3">
                    <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å, —â–æ –ø—Ä–∏—ó—Ö–∞–ª–∞:</label>
                    <div class="input-group">
                        <input type="number" step="0.001" id="supplyAmount" class="form-control">
                        <span class="input-group-text" id="supplyUnitLabel">—à—Ç</span>
                    </div>
                </div>
                <button onclick="handleTransaction('supply')" class="btn btn-success btn-xl">–î–æ–¥–∞—Ç–∏ –Ω–∞ —Å–∫–ª–∞–¥</button>
            </div>
        </div>

        <div class="tab-pane fade" id="reportSection">
            <div class="d-flex justify-content-between no-print mb-2">
                <h4>–ó–∞–ª–∏—à–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥—ñ</h4>
                <button onclick="window.print()" class="btn btn-primary">üñ®Ô∏è –î—Ä—É–∫—É–≤–∞—Ç–∏</button>
            </div>
            
            <div class="print-header">
                <span>—Ñ–æ–Ω—Ç–∞–Ω</span>
                <span style="float: right;" id="reportDate"></span>
            </div>

            <table id="reportTable">
                <thead>
                    <tr>
                        <th style="width: 20%;">–ö–æ–¥</th>
                        <th style="width: 50%;">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É</th>
                        <th style="width: 10%;">–û–¥.</th>
                        <th style="width: 20%;">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                    </tr>
                </thead>
                <tbody id="reportBody">
                    </tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="pills-add">
            <div class="card p-4">
                <h4>–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–∞—Ä—Ç–∫—É —Ç–æ–≤–∞—Ä—É</h4>
                <input type="text" id="newCode" class="form-control mb-2" placeholder="–ö–æ–¥ (–Ω–∞–ø—Ä. 2204218200)">
                <input type="text" id="newName" class="form-control mb-2" placeholder="–ù–∞–∑–≤–∞ (–Ω–∞–ø—Ä. –ü–∏–≤–æ –í–∞—Ä—à—Ç–∞–π–Ω–µ—Ä)">
                <select id="newUnit" class="form-select mb-2">
                    <option value="–ª">–õ—ñ—Ç—Ä–∏ (–ª)</option>
                    <option value="—à—Ç">–®—Ç—É–∫–∏ (—à—Ç)</option>
                </select>
                <input type="number" id="newStartQty" class="form-control mb-3" placeholder="–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ª–∏—à–æ–∫">
                <button onclick="addNewProduct()" class="btn btn-dark w-100">–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–æ–≤–∞—Ä</button>
            </div>
        </div>

    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, onSnapshot, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


  const firebaseConfig = {
  apiKey: "AIzaSyDj5NydpupL2OXv3-_W7r7wpR0tbWblyI0",
  authDomain: "barmen-c0060.firebaseapp.com",
  projectId: "barmen-c0060",
  storageBucket: "barmen-c0060.firebasestorage.app",
  messagingSenderId: "442747151502",
  appId: "1:442747151502:web:827cdba7d2ae0e660195df"
};

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const productsCol = collection(db, 'products');
  const logsCol = collection(db, 'logs'); // –î–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó —Ç–∞ –∞–∫—Ü–∏–∑—ñ–≤

  let allProducts = [];

  // --- 2. –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –î–ê–ù–ò–• (–†–ï–ê–õ–¨–ù–ò–ô –ß–ê–°) ---
  onSnapshot(productsCol, (snapshot) => {
      allProducts = [];
      const selectSale = document.getElementById('saleProduct');
      const selectSupply = document.getElementById('supplyProduct');
      const reportBody = document.getElementById('reportBody');
      
      selectSale.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å...</option>';
      selectSupply.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å...</option>';
      reportBody.innerHTML = '';

      snapshot.docs.forEach(docSnap => {
          const data = docSnap.data();
          const product = { id: docSnap.id, ...data };
          allProducts.push(product);

          // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Å–ø–∏—Å–∫—ñ–≤
          const optionText = `${data.name} (–ó–∞–ª: ${formatQty(data.quantity, data.unit)} ${data.unit})`;
          const opt1 = new Option(optionText, product.id);
          const opt2 = new Option(optionText, product.id);
          
          // –î–æ–¥–∞—î–º–æ –∞—Ç—Ä–∏–±—É—Ç–∏ –¥–ª—è JS
          opt1.dataset.unit = data.unit;
          opt2.dataset.unit = data.unit;

          selectSale.add(opt1);
          selectSupply.add(opt2);

          // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –∑–≤—ñ—Ç—É
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${data.code}</td>
            <td>${data.name}</td>
            <td>${data.unit}</td>
            <td>${formatQty(data.quantity, data.unit)}</td>
          `;
          reportBody.appendChild(tr);
      });
      
      // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –∑–∞ –∫–æ–¥–æ–º (—è–∫ –Ω–∞ —Ñ–æ—Ç–æ)
      sortReport();
  });

  // --- 3. –§–£–ù–ö–¶–Ü–á ---

  window.formatQty = (num, unit) => {
      if (unit === '–ª') return parseFloat(num).toFixed(3);
      return Math.floor(num);
  }

  // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ø–∏—Å—É "–ª" –∞–±–æ "—à—Ç" –±—ñ–ª—è –ø–æ–ª—è –≤–≤–æ–¥—É
  window.updateUnitLabel = (type) => {
      const select = document.getElementById(type + 'Product');
      const unitLabel = document.getElementById(type + 'UnitLabel');
      if (select.selectedIndex > 0) {
          const unit = select.options[select.selectedIndex].dataset.unit;
          unitLabel.innerText = unit;
      }
  };

  // –õ–æ–≥—ñ–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π (–ü—Ä–æ–¥–∞–∂ –∞–±–æ –ü–æ—Å—Ç–∞–≤–∫–∞)
  window.handleTransaction = async (type) => {
      const prodId = document.getElementById(type + 'Product').value;
      const amountInput = document.getElementById(type + 'Amount');
      const amount = parseFloat(amountInput.value);
      const excise = document.getElementById('exciseCode').value;

      if (!prodId || isNaN(amount) || amount <= 0) {
          alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä —ñ –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å");
          return;
      }

      const productRef = doc(db, 'products', prodId);
      const product = allProducts.find(p => p.id === prodId);
      
      let newQty = product.quantity;
      if (type === 'sale') {
          if (product.quantity < amount) {
              alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ç–æ–≤–∞—Ä—É –Ω–∞ –∑–∞–ª–∏—à–∫—É!");
              return;
          }
          newQty -= amount;
      } else {
          newQty += amount;
      }

      try {
          // 1. –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–∏—à–æ–∫
          await updateDoc(productRef, { quantity: newQty });

          // 2. –ü–∏—à–µ–º–æ –ª–æ–≥ (—ñ—Å—Ç–æ—Ä—ñ—è + –∞–∫—Ü–∏–∑)
          await addDoc(logsCol, {
              productName: product.name,
              productCode: product.code,
              type: type, // 'sale' or 'supply'
              amount: amount,
              exciseCode: excise || "N/A",
              timestamp: serverTimestamp()
          });

          alert("–£—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!");
          
          // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—ñ–≤
          amountInput.value = '';
          document.getElementById('exciseCode').value = '';
          if(type === 'sale') document.getElementById('saleProduct').selectedIndex = 0;
          
      } catch (e) {
          console.error(e);
          alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç.");
      }
  };

  // –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä—É
  window.addNewProduct = async () => {
      const code = document.getElementById('newCode').value;
      const name = document.getElementById('newName').value;
      const unit = document.getElementById('newUnit').value;
      const qty = parseFloat(document.getElementById('newStartQty').value);

      if(!code || !name) return alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è");

      try {
          await addDoc(productsCol, {
              code: code,
              name: name,
              unit: unit,
              quantity: qty || 0
          });
          alert("–¢–æ–≤–∞—Ä —Å—Ç–≤–æ—Ä–µ–Ω–æ!");
          document.getElementById('newCode').value = '';
          document.getElementById('newName').value = '';
      } catch (e) {
          alert("–ü–æ–º–∏–ª–∫–∞: " + e.message);
      }
  };

  // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
  function sortReport() {
    const table = document.getElementById('reportTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.rows);
    
    rows.sort((a, b) => {
        const codeA = a.cells[0].innerText;
        const codeB = b.cells[0].innerText;
        return codeA.localeCompare(codeB);
    });
    
    rows.forEach(row => tbody.appendChild(row));
  }

  // –î–∞—Ç–∞ –¥–ª—è –∑–≤—ñ—Ç—É
  const date = new Date();
  document.getElementById('reportDate').innerText = date.toLocaleDateString('uk-UA');

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
