<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Manager - –§–æ–Ω—Ç–∞–Ω</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .btn-xl { padding: 15px 20px; font-size: 1.2rem; width: 100%; margin-bottom: 10px; }
        
        /* –°—Ç–∏–ª—ñ —Ç–∞–±–ª–∏—Ü—ñ –∑–≤—ñ—Ç—É */
        #reportTable { width: 100%; border-collapse: collapse; background: white; font-family: 'Courier New', Courier, monospace; font-size: 14px; color: black; }
        #reportTable th, #reportTable td { border: 2px solid #000; padding: 4px 8px; }
        #reportTable th { text-align: left; background-color: #eee; }
        .print-header { display: none; margin-bottom: 10px; font-weight: bold; }

        /* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥—Ä—É–∫—É */
        @media print {
            body * { visibility: hidden; }
            #pills-report, #pills-report * { visibility: visible; }
            #pills-report { position: absolute; left: 0; top: 0; width: 100%; display: block !important; opacity: 1 !important; }
            .print-header { display: block; }
            .no-print, .btn-delete-col { display: none !important; }
        }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="text-center mb-4">üç∫ Bar Manager: –§–æ–Ω—Ç–∞–Ω</h2>

    <ul class="nav nav-pills mb-3 justify-content-center no-print" id="pills-tab" role="tablist">
        <li class="nav-item"><button class="nav-link active" id="pills-sale-tab" data-bs-toggle="pill" data-bs-target="#pills-sale" type="button">üí∞ –ü—Ä–æ–¥–∞–∂</button></li>
        <li class="nav-item"><button class="nav-link" id="pills-supply-tab" data-bs-toggle="pill" data-bs-target="#pills-supply" type="button">üöö –ü–æ—Å—Ç–∞–≤–∫–∞</button></li>
        <li class="nav-item"><button class="nav-link" id="pills-report-tab" data-bs-toggle="pill" data-bs-target="#pills-report" type="button">üìÑ –ó–≤—ñ—Ç</button></li>
        <li class="nav-item"><button class="nav-link" id="pills-add-tab" data-bs-toggle="pill" data-bs-target="#pills-add" type="button">‚ûï –¢–æ–≤–∞—Ä</button></li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        
        <div class="tab-pane fade show active" id="pills-sale">
            <div class="card p-4">
                <h4>–ü—Ä–æ–≤–µ—Å—Ç–∏ –ø—Ä–æ–¥–∞–∂</h4>
                <div class="mb-3">
                    <label>–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä:</label>
                    <select id="saleProduct" class="form-select" onchange="onProductSelect('sale')"></select>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å / –û–±'—î–º:</label>
                        <div class="input-group">
                            <input type="number" step="0.001" id="saleAmount" class="form-control">
                            <span class="input-group-text" id="saleUnitLabel">–æ–¥</span>
                        </div>
                        <small class="text-muted" id="saleHint">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>–ê–∫—Ü–∏–∑ (—è–∫—â–æ —î):</label>
                        <input type="text" id="exciseCode" class="form-control" placeholder="–°–∫–∞–Ω—É–≤–∞—Ç–∏...">
                    </div>
                </div>
                <button onclick="handleTransaction('sale')" class="btn btn-danger btn-xl">–ü–†–û–î–ê–¢–ò</button>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-supply">
            <div class="card p-4">
                <h4>–ü—Ä–∏–π–Ω—è—Ç–∏ —Ç–æ–≤–∞—Ä</h4>
                <div class="mb-3">
                    <label>–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä:</label>
                    <select id="supplyProduct" class="form-select" onchange="onProductSelect('supply')"></select>
                </div>
                <div class="mb-3">
                    <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å, —â–æ –ø—Ä–∏—ó—Ö–∞–ª–∞:</label>
                    <div class="input-group">
                        <input type="number" step="0.001" id="supplyAmount" class="form-control">
                        <span class="input-group-text" id="supplyUnitLabel">–æ–¥</span>
                    </div>
                </div>
                <button onclick="handleTransaction('supply')" class="btn btn-success btn-xl">–î–û–î–ê–¢–ò –ù–ê –°–ö–õ–ê–î</button>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-report">
            <div class="d-flex justify-content-between no-print mb-2">
                <h4>–ó–∞–ª–∏—à–∫–∏ (–≤—ñ–¥ –Ω–∞–π–±—ñ–ª—å—à–æ–≥–æ)</h4>
                <button onclick="window.print()" class="btn btn-primary">üñ®Ô∏è –î—Ä—É–∫—É–≤–∞—Ç–∏ –∑–≤—ñ—Ç</button>
            </div>
            
            <div class="print-header">
                <span>—Ñ–æ–Ω—Ç–∞–Ω</span>
                <span style="float: right;" id="reportDate"></span>
            </div>

            <table id="reportTable">
                <thead>
                    <tr>
                        <th style="width: 20%;">–ö–æ–¥</th>
                        <th style="width: 45%;">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É</th>
                        <th style="width: 10%;">–û–¥.</th>
                        <th style="width: 15%;">–ó–∞–ª–∏—à–æ–∫</th>
                        <th class="btn-delete-col" style="width: 10%;">–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody id="reportBody">
                    <tr><td colspan="5" class="text-center">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="pills-add">
            <div class="card p-4">
                <h4>–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–∞—Ä—Ç–∫—É —Ç–æ–≤–∞—Ä—É</h4>
                <div class="mb-2">
                    <label>–®—Ç—Ä–∏—Ö–∫–æ–¥ / –ö–æ–¥:</label>
                    <input type="text" id="newCode" class="form-control" placeholder="2204218200">
                </div>
                <div class="mb-2">
                    <label>–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É:</label>
                    <input type="text" id="newName" class="form-control" placeholder="–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É">
                </div>
                <div class="row mb-2">
                    <div class="col-6">
                        <label>–û–¥–∏–Ω–∏—Ü—è –≤–∏–º—ñ—Ä—É:</label>
                        <select id="newUnit" class="form-select">
                            <option value="–ª">–õ—ñ—Ç—Ä–∏ (–ª)</option>
                            <option value="—à—Ç">–®—Ç—É–∫–∏ (—à—Ç)</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label>–°—Ç–∞–Ω–¥. –ø–æ—Ä—Ü—ñ—è:</label>
                        <input type="number" step="0.001" id="newDefaultPortion" class="form-control" placeholder="0.4">
                    </div>
                </div>
                <div class="mb-3">
                    <label>–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ª–∏—à–æ–∫:</label>
                    <input type="number" step="0.001" id="newStartQty" class="form-control" value="0">
                </div>
                <button onclick="addNewProduct()" class="btn btn-dark w-100">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ç–æ–≤–∞—Ä</button>
            </div>
        </div>

    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // --- –í–ê–ñ–õ–ò–í–û: –ó–ê–ú–Ü–ù–Ü–¢–¨ –¶–ï–ô –ë–õ–û–ö –ù–ê –í–ê–® –ö–û–ù–§–Ü–ì ---
  const firebaseConfig = {
  apiKey: "AIzaSyDj5NydpupL2OXv3-_W7r7wpR0tbWblyI0",
  authDomain: "barmen-c0060.firebaseapp.com",
  projectId: "barmen-c0060",
  storageBucket: "barmen-c0060.firebasestorage.app",
  messagingSenderId: "442747151502",
  appId: "1:442747151502:web:827cdba7d2ae0e660195df"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const productsCol = collection(db, 'products');
  const logsCol = collection(db, 'logs');

  let allProducts = [];

  // –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è (–±–µ–∑–ø–µ—á–Ω–∞)
  function safeFormat(num, unit) {
      const val = Number(num);
      if (isNaN(val)) return "0";
      if (unit === '–ª') return val.toFixed(3);
      return Math.floor(val);
  }

  // --- –°–õ–£–•–ê–Ñ–ú–û –î–ê–ù–Ü ---
  onSnapshot(productsCol, (snapshot) => {
      allProducts = [];
      const selectSale = document.getElementById('saleProduct');
      const selectSupply = document.getElementById('supplyProduct');
      const reportBody = document.getElementById('reportBody');
      
      const currentSaleVal = selectSale.value;

      selectSale.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä --</option>';
      selectSupply.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä --</option>';
      reportBody.innerHTML = '';

      if (snapshot.empty) {
          reportBody.innerHTML = '<tr><td colspan="5" class="text-center">–ù–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤. –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à–∏–π —Ç–æ–≤–∞—Ä!</td></tr>';
          return;
      }

      snapshot.docs.forEach(docSnap => {
          const data = docSnap.data();
          const product = { id: docSnap.id, ...data };
          allProducts.push(product);

          const safeQty = (data.quantity !== undefined) ? data.quantity : 0;
          const displayQty = safeFormat(safeQty, data.unit);

          // –î–æ–¥–∞—î–º–æ –≤ —Å–µ–ª–µ–∫—Ç–∏
          const label = `${data.name} (–ó–∞–ª: ${displayQty})`;
          const opt1 = document.createElement('option');
          opt1.value = product.id;
          opt1.text = label;
          opt1.dataset.defaultPortion = data.defaultPortion || 1; 
          opt1.dataset.unit = data.unit;

          const opt2 = opt1.cloneNode(true);

          selectSale.appendChild(opt1);
          selectSupply.appendChild(opt2);

          // –î–æ–¥–∞—î–º–æ —Ä—è–¥–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü—é
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${data.code || '-'}</td>
            <td>${data.name}</td>
            <td>${data.unit}</td>
            <td>${displayQty}</td>
            <td class="btn-delete-col text-center">
                <button class="btn btn-sm btn-outline-danger" onclick="window.deleteProduct('${product.id}', '${data.name}')">üóëÔ∏è</button>
            </td>
          `;
          reportBody.appendChild(tr);
      });

      if(currentSaleVal) {
          const exists = Array.from(selectSale.options).some(o => o.value === currentSaleVal);
          if(exists) selectSale.value = currentSaleVal;
      }

      // –í–∏–∫–ª–∏–∫–∞—î–º–æ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
      sortReport();
  });

  // --- –õ–û–ì–Ü–ö–ê –Ü–ù–¢–ï–†–§–ï–ô–°–£ ---

  window.onProductSelect = (type) => {
      const select = document.getElementById(type + 'Product');
      const amountInput = document.getElementById(type + 'Amount');
      const unitLabel = document.getElementById(type + 'UnitLabel');

      if (select.selectedIndex > 0) {
          const opt = select.options[select.selectedIndex];
          unitLabel.innerText = opt.dataset.unit;
          
          if (type === 'sale') {
             amountInput.value = opt.dataset.defaultPortion;
             document.getElementById('saleHint').innerText = `–ü–æ—Ä—Ü—ñ—è: ${opt.dataset.defaultPortion} ${opt.dataset.unit}`;
          } else {
             amountInput.value = '';
          }
      } else {
          amountInput.value = '';
          unitLabel.innerText = '–æ–¥';
      }
  };

  window.handleTransaction = async (type) => {
      const prodId = document.getElementById(type + 'Product').value;
      const amountInput = document.getElementById(type + 'Amount');
      const amount = parseFloat(amountInput.value);
      const excise = document.getElementById('exciseCode').value;

      if (!prodId || isNaN(amount) || amount <= 0) {
          alert("–ü–æ–º–∏–ª–∫–∞: –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–æ–≤–∞—Ä —Ç–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å");
          return;
      }

      const productRef = doc(db, 'products', prodId);
      const product = allProducts.find(p => p.id === prodId);
      
      let currentQty = (product.quantity !== undefined) ? Number(product.quantity) : 0;
      let newQty = currentQty;

      if (type === 'sale') {
          if (currentQty < amount) {
              if(!confirm(`–ù–∞ –∑–∞–ª–∏—à–∫—É –≤—Å—å–æ–≥–æ ${currentQty}. –£—Å–µ –æ–¥–Ω–æ –ø—Ä–æ–¥–∞—Ç–∏ –≤ –º—ñ–Ω—É—Å?`)) return;
          }
          newQty -= amount;
      } else {
          newQty += amount;
      }

      try {
          await updateDoc(productRef, { quantity: newQty });
          await addDoc(logsCol, {
              productName: product.name,
              productCode: product.code,
              type: type,
              amount: amount,
              exciseCode: excise || "N/A",
              timestamp: serverTimestamp()
          });

          if(type === 'sale') {
              const opt = document.getElementById('saleProduct').options[document.getElementById('saleProduct').selectedIndex];
              amountInput.value = opt.dataset.defaultPortion;
              document.getElementById('exciseCode').value = '';
          } else {
              amountInput.value = '';
          }
          alert("–ó–±–µ—Ä–µ–∂–µ–Ω–æ!");
      } catch (e) {
          alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: " + e.message);
      }
  };

  window.addNewProduct = async () => {
      const code = document.getElementById('newCode').value;
      const name = document.getElementById('newName').value;
      const unit = document.getElementById('newUnit').value;
      const defPortion = parseFloat(document.getElementById('newDefaultPortion').value);
      const qty = parseFloat(document.getElementById('newStartQty').value);

      if(!code || !name || isNaN(defPortion)) return alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É, –∫–æ–¥ —ñ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –ø–æ—Ä—Ü—ñ—é!");

      try {
          await addDoc(productsCol, {
              code: code,
              name: name,
              unit: unit,
              defaultPortion: defPortion,
              quantity: qty || 0
          });
          alert("–¢–æ–≤–∞—Ä —Å—Ç–≤–æ—Ä–µ–Ω–æ!");
          document.getElementById('newCode').value = '';
          document.getElementById('newName').value = '';
          document.getElementById('newDefaultPortion').value = '';
          document.getElementById('newStartQty').value = '0';
      } catch (e) {
          alert("–ü–æ–º–∏–ª–∫–∞: " + e.message);
      }
  };

  window.deleteProduct = async (id, name) => {
      if(confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä "${name}"?`)) {
          try {
              await deleteDoc(doc(db, "products", id));
          } catch(e) {
              alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏: " + e.message);
          }
      }
  };

  // --- –ù–û–í–ê –§–£–ù–ö–¶–Ü–Ø –°–û–†–¢–£–í–ê–ù–ù–Ø ---
  function sortReport() {
    const table = document.getElementById('reportTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.rows);
    
    rows.sort((a, b) => {
        // –û—Ç—Ä–∏–º—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ 4-–≥–æ —Å—Ç–æ–≤–ø—á–∏–∫–∞ (—ñ–Ω–¥–µ–∫—Å 3), –±–æ —Ç–∞–º –∫—ñ–ª—å–∫—ñ—Å—Ç—å
        // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –≤ —á–∏—Å–ª–æ (parseFloat), —â–æ–± 10 –±—É–ª–æ –±—ñ–ª—å—à–µ –∑–∞ 2
        const qtyA = parseFloat(a.cells[3].innerText) || 0;
        const qtyB = parseFloat(b.cells[3].innerText) || 0;
        
        // –°–æ—Ä—Ç—É—î–º–æ –≤—ñ–¥ –ë–Ü–õ–¨–®–û–ì–û –¥–æ –º–µ–Ω—à–æ–≥–æ (b - a)
        return qtyB - qtyA;
    });
    
    rows.forEach(row => tbody.appendChild(row));
  }

  const date = new Date();
  document.getElementById('reportDate').innerText = date.toLocaleDateString('uk-UA');
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
